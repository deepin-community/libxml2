Reviewed-by: Aron Xu <aron@debian.org>

From 30d7660ba87c8487b26582ccc050f4d2880ccb3c Mon Sep 17 00:00:00 2001
From: Nick Wellnhofer <wellnhofer@aevum.de>
Date: Tue, 28 Nov 2023 13:27:25 +0100
Subject: [PATCH] tree: Fix #583 again

Only set doc->intSubset after successful copy to avoid dangling pointers
in error case.
---
 tree.c | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

Index: libxml2-2.12.7+dfsg+really2.9.14/tree.c
===================================================================
--- libxml2-2.12.7+dfsg+really2.9.14.orig/tree.c
+++ libxml2-2.12.7+dfsg+really2.9.14/tree.c
@@ -4370,6 +4370,7 @@ static xmlNodePtr
 xmlStaticCopyNodeList(xmlNodePtr node, xmlDocPtr doc, xmlNodePtr parent) {
     xmlNodePtr ret = NULL;
     xmlNodePtr p = NULL,q;
+    xmlDtdPtr newSubset = NULL;
 
     while (node != NULL) {
 #ifdef LIBXML_TREE_ENABLED
@@ -4378,12 +4379,12 @@ xmlStaticCopyNodeList(xmlNodePtr node, x
 		node = node->next;
 		continue;
 	    }
-	    if (doc->intSubset == NULL) {
+	    if ((doc->intSubset == NULL) && (newSubset == NULL)) {
 		q = (xmlNodePtr) xmlCopyDtd( (xmlDtdPtr) node );
 		if (q == NULL) return(NULL);
 		q->doc = doc;
 		q->parent = parent;
-		doc->intSubset = (xmlDtdPtr) q;
+		newSubset = (xmlDtdPtr) q;
 		xmlAddChild(parent, q);
 	    } else {
 		q = (xmlNodePtr) doc->intSubset;
@@ -4404,6 +4405,8 @@ xmlStaticCopyNodeList(xmlNodePtr node, x
 	}
 	node = node->next;
     }
+    if ((doc != NULL) && (newSubset != NULL))
+        doc->intSubset = newSubset;
     return(ret);
 }
 
